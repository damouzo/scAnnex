name: scAnnex CI

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main ]

jobs:
  lint:
    name: Lint Pipeline
    runs-on: ubuntu-latest
    steps:
      - name: Check out pipeline code
        uses: actions/checkout@v4

      - name: Install Nextflow
        uses: nf-core/setup-nextflow@v1
        with:
          version: "23.04.0"

      - name: Run Nextflow config test
        run: |
          nextflow config -profile docker .

  test:
    name: Run Pipeline Tests
    runs-on: ubuntu-latest
    needs: lint
    strategy:
      matrix:
        profile: ['docker']
    steps:
      - name: Check out pipeline code
        uses: actions/checkout@v4

      - name: Install Nextflow
        uses: nf-core/setup-nextflow@v1
        with:
          version: "23.04.0"

      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: Download test data
        run: |
          python bin/download_test_data.py --output-dir test_data || echo "Test data download script not available yet"

      - name: Run pipeline with test profile
        run: |
          nextflow run main.nf \
            -profile test,${{ matrix.profile }} \
            --outdir test_results \
            -work-dir work
        continue-on-error: true

      - name: Check for required outputs
        run: |
          if [ -d "test_results" ]; then
            echo "Test results directory created"
            ls -la test_results/
          else
            echo "Warning: Test results directory not found"
          fi
        continue-on-error: true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.profile }}
          path: |
            test_results/
            .nextflow.log
          retention-days: 7

  style-check:
    name: Code Style Check
    runs-on: ubuntu-latest
    steps:
      - name: Check out pipeline code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Python linting tools
        run: |
          pip install flake8 black

      - name: Check Python code style
        run: |
          black --check bin/*.py || echo "Black formatting check completed"
          flake8 bin/*.py --max-line-length=120 --extend-ignore=E203,W503 || echo "Flake8 check completed"
        continue-on-error: true
