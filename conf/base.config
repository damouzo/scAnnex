/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Base Nextflow config file
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    A 'blank slate' config file, appropriate for general use on most high performance
    compute environments. Assumes that all software is installed and available on
    the PATH. Runs in `local` executor mode.
    
    Resources are dynamically bounded by params.max_memory and params.max_cpus.
----------------------------------------------------------------------------------------
*/

process {
    cpus   = { Math.min(1, params.max_cpus as int) }
    memory = { 
        def mem = 6.GB * task.attempt
        mem.compareTo(params.max_memory as nextflow.util.MemoryUnit) == 1 ? 
            params.max_memory as nextflow.util.MemoryUnit : mem
    }
    time   = { 
        def t = 4.h * task.attempt
        t.compareTo(params.max_time as nextflow.util.Duration) == 1 ? 
            params.max_time as nextflow.util.Duration : t
    }

    errorStrategy = { task.exitStatus in ((130..145) + 104) ? 'retry' : 'finish' }
    maxRetries    = 1
    maxErrors     = '-1'

    // Process-specific resource requirements
    withLabel: 'process_single' {
        cpus   = { Math.min(1, params.max_cpus as int) }
        memory = { 
            def mem = 6.GB * task.attempt
            mem.compareTo(params.max_memory as nextflow.util.MemoryUnit) == 1 ? 
                params.max_memory as nextflow.util.MemoryUnit : mem
        }
        time   = { 
            def t = 4.h * task.attempt
            t.compareTo(params.max_time as nextflow.util.Duration) == 1 ? 
                params.max_time as nextflow.util.Duration : t
        }
    }
    withLabel: 'process_low' {
        cpus   = { Math.min(2, params.max_cpus as int) }
        memory = { 
            def requested = 6.GB * task.attempt
            def max_mem = params.max_memory as nextflow.util.MemoryUnit
            requested.compareTo(max_mem) == 1 ? max_mem : requested
        }
        time   = { 
            def t = 4.h * task.attempt
            t.compareTo(params.max_time as nextflow.util.Duration) == 1 ? 
                params.max_time as nextflow.util.Duration : t
        }
    }
    withLabel: 'process_medium' {
        cpus   = { Math.min(6, params.max_cpus as int) }
        memory = { 
            // Use 60% of max_memory, with minimum of 6GB for first attempt
            def max_mem = params.max_memory as nextflow.util.MemoryUnit
            def base = (max_mem * 0.6).compareTo(6.GB) == -1 ? 6.GB : max_mem * 0.6
            def requested = base * task.attempt
            requested.compareTo(max_mem) == 1 ? max_mem : requested
        }
        time   = { 
            def t = 8.h * task.attempt
            t.compareTo(params.max_time as nextflow.util.Duration) == 1 ? 
                params.max_time as nextflow.util.Duration : t
        }
    }
    withLabel: 'process_high' {
        cpus   = { Math.min(12, params.max_cpus as int) }
        memory = { 
            // Use 75% of max_memory, with minimum of 6GB for first attempt
            def max_mem = params.max_memory as nextflow.util.MemoryUnit
            def base = (max_mem * 0.75).compareTo(6.GB) == -1 ? 6.GB : max_mem * 0.75
            def requested = base * task.attempt
            requested.compareTo(max_mem) == 1 ? max_mem : requested
        }
        time   = { 
            def t = 16.h * task.attempt
            t.compareTo(params.max_time as nextflow.util.Duration) == 1 ? 
                params.max_time as nextflow.util.Duration : t
        }
    }
    withLabel: 'process_long' {
        time   = { 
            def t = 20.h * task.attempt
            t.compareTo(params.max_time as nextflow.util.Duration) == 1 ? 
                params.max_time as nextflow.util.Duration : t
        }
    }
    withLabel: 'process_high_memory' {
        memory = { 
            def requested = 8.GB * task.attempt
            def max_mem = params.max_memory as nextflow.util.MemoryUnit
            requested.compareTo(max_mem) == 1 ? max_mem : requested
        }
    }
    withLabel: 'error_ignore' {
        errorStrategy = 'ignore'
    }
    withLabel: 'error_retry' {
        errorStrategy = 'retry'
        maxRetries    = 2
    }
}
