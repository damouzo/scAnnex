/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Config file for defining DSL2 per module options and publishing paths
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Available keys to override module options:
        ext.args   = Additional arguments appended to command in module.
        ext.args2  = Second set of arguments appended to command in module (multi-tool modules).
        ext.args3  = Third set of arguments appended to command in module (multi-tool modules).
        ext.prefix = File name prefix for output files.
----------------------------------------------------------------------------------------
*/

process {
    publishDir = [
        path: { "${params.outdir}/${task.process.tokenize(':')[-1].tokenize('_')[0].toLowerCase()}" },
        mode: params.publish_dir_mode,
        saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
    ]

    withName: 'UNIFY_INPUT' {
        ext.args = ''
        publishDir = [
            path: { "${params.outdir}/unified_input" },
            mode: params.publish_dir_mode,
            pattern: '*.h5ad'
        ]
    }

    withName: 'QUALITY_CONTROL' {
        ext.args = [
            "--min-genes ${params.min_genes}",
            "--min-cells ${params.min_cells}",
            params.use_mad_thresholds ? "--use-mad-thresholds" : '',
            params.use_mad_thresholds ? "--mad-multiplier ${params.mad_multiplier}" : '',
            params.max_genes && !params.use_mad_thresholds ? "--max-genes ${params.max_genes}" : '',
            params.max_counts && !params.use_mad_thresholds ? "--max-counts ${params.max_counts}" : '',
            params.max_mito_percent && !params.use_mad_thresholds ? "--max-mito ${params.max_mito_percent}" : '',
            "--output-dir \${PWD}/qc_results"
        ].join(' ').trim()
        publishDir = [
            [
                path: { "${params.outdir}/qc" },
                mode: params.publish_dir_mode,
                pattern: '*.h5ad'
            ],
            [
                path: { "${params.outdir}/qc/plots" },
                mode: params.publish_dir_mode,
                pattern: '*.{png,pdf}'
            ],
            [
                path: { "${params.outdir}/qc/results" },
                mode: params.publish_dir_mode,
                pattern: 'qc_results/*'
            ]
        ]
    }

    withName: 'DOUBLET_DETECTION' {
        ext.args = "--expected-doublet-rate ${params.expected_doublet_rate}"
        publishDir = [
            [
                path: { "${params.outdir}/doublet_detection" },
                mode: params.publish_dir_mode,
                pattern: '*.h5ad'
            ],
            [
                path: { "${params.outdir}/doublet_detection/plots" },
                mode: params.publish_dir_mode,
                pattern: '*.{png,pdf}'
            ]
        ]
    }

    withName: 'NORMALIZE_INTEGRATE' {
        ext.args = [
            "--normalization-method ${params.normalization_method}",
            "--target-sum ${params.target_sum}",
            "--n-top-genes ${params.n_top_genes}",
            "--n-pcs ${params.n_pcs}",
            "--n-neighbors ${params.n_neighbors}",
            "--umap-min-dist ${params.umap_min_dist}",
            params.run_integration && params.batch_key ? "--batch-key ${params.batch_key}" : '',
            params.run_integration ? "--run-integration" : '',
            params.run_integration ? "--integration-method ${params.integration_method}" : '',
            params.run_integration ? "--harmony-theta ${params.harmony_theta}" : '',
            params.run_integration ? "--harmony-max-iter ${params.harmony_max_iter}" : '',
            "--output-dir \${PWD}/integration_results"
        ].join(' ').trim()
        publishDir = [
            [
                path: { "${params.outdir}/normalized" },
                mode: params.publish_dir_mode,
                pattern: '*.h5ad'
            ],
            [
                path: { "${params.outdir}/normalized/integration_results" },
                mode: params.publish_dir_mode,
                pattern: 'integration_results/*'
            ]
        ]
    }

    withName: 'DIMENSIONALITY_REDUCTION' {
        ext.args = [
            "--n-pcs ${params.n_pcs}",
            "--n-neighbors ${params.n_neighbors}",
            "--umap-min-dist ${params.umap_min_dist}",
            "--clustering-method ${params.clustering_method}",
            "--resolutions ${params.clustering_resolutions}"
        ].join(' ').trim()
        publishDir = [
            [
                path: { "${params.outdir}/dimensionality_reduction" },
                mode: params.publish_dir_mode,
                pattern: '*.h5ad'
            ],
            [
                path: { "${params.outdir}/dimensionality_reduction/plots" },
                mode: params.publish_dir_mode,
                pattern: '*.{png,pdf}'
            ]
        ]
    }

    withName: 'AUTO_ANNOTATION' {
        ext.args = params.marker_list ? "--marker-list ${params.marker_list}" : ''
        publishDir = [
            [
                path: { "${params.outdir}/annotation" },
                mode: params.publish_dir_mode,
                pattern: '*.h5ad'
            ],
            [
                path: { "${params.outdir}/annotation/plots" },
                mode: params.publish_dir_mode,
                pattern: '*.{png,pdf}'
            ]
        ]
    }
}
