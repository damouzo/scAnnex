/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Nextflow config file for running minimal tests
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Defines input files and everything required to run a fast and simple pipeline test.
    Use as follows:
        nextflow run main.nf -profile test,docker --outdir <OUTDIR>
----------------------------------------------------------------------------------------
*/

params {
    config_profile_name        = 'Test profile'
    config_profile_description = 'Minimal test dataset (1k cells) to check pipeline function'

    // Limit resources so that this can run on local machine
    max_cpus   = 4
    max_memory = '8.GB'
    max_time   = '2.h'

    // Input data - using demo data from PBMC 1k
    input      = 'data_demo/H5AD/pbmc_1k.h5ad'
    input_type = 'h5ad'
    outdir     = 'test_results'

    // QC options - use MAD thresholds for automatic filtering
    min_genes          = 200
    min_cells          = 3
    use_mad_thresholds = true
    mad_multiplier     = 5.0

    // Doublet detection - disable to speed up test
    run_doublet_detection = false
    
    // Normalization - optimized for small dataset
    normalization_method = 'log'
    target_sum           = 10000
    n_top_genes          = 1000  // Reduced from 2000 for faster processing

    // Integration - test with batch correction
    run_integration      = true
    batch_key            = 'batch'
    integration_method   = 'harmony'
    harmony_theta        = 2.0
    harmony_max_iter     = 5  // Reduced from 10 for faster convergence

    // Dimensionality reduction - optimized for 1k cells
    n_pcs         = 20   // Reduced from 50 for small dataset
    n_neighbors   = 10   // Reduced from 15 for small dataset
    umap_min_dist = 0.5

    // Clustering
    clustering_method      = 'leiden'
    clustering_resolutions = '0.4,0.8'  // Reduced resolutions for test

    // Annotation
    run_auto_annotation = false  // Disable for test
}

// Process resource requirements for test profile
process {
    withLabel: 'process_low' {
        cpus   = 2
        memory = 4.GB
        time   = 30.m
    }
    withLabel: 'process_medium' {
        cpus   = 2
        memory = 6.GB
        time   = 1.h
    }
    withLabel: 'process_high' {
        cpus   = 4
        memory = 8.GB
        time   = 2.h
    }
}
