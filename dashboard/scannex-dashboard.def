Bootstrap: docker
From: rocker/shiny:4.3.3

%labels
    Maintainer scAnnex Development Team
    Description Interactive Shiny dashboard for scRNA-seq analysis results
    Version 1.0.0

%help
    scAnnex Interactive Dashboard
    
    This Singularity container provides an interactive R Shiny dashboard
    for visualizing scRNA-seq analysis results from the scAnnex pipeline.
    
    USAGE:
        # Build the container (requires sudo or --fakeroot)
        apptainer build scannex-dashboard.sif scannex-dashboard.def
        
        # Run the dashboard
        apptainer run \
            --bind /path/to/results:/data \
            scannex-dashboard.sif
        
        # Access the dashboard at http://localhost:3838
    
    FEATURES:
        - Interactive UMAP plots colored by metadata
        - QC metrics visualization
        - Gene expression visualization
        - Cell metadata exploration
        - Backed mode for large datasets (>100k cells)
    
    DATA REQUIREMENTS:
        The container expects an H5AD file with:
        - Cell metadata in .obs
        - UMAP coordinates in .obsm['X_umap']
        - Gene expression matrix in .X
        - Optional: QC plots and reports in a separate directory

%post
    # Update and install system dependencies
    apt-get update && apt-get install -y \
        python3 \
        python3-pip \
        python3-dev \
        libhdf5-dev \
        libxml2-dev \
        libcurl4-openssl-dev \
        libssl-dev \
        libpng-dev \
        git \
        && rm -rf /var/lib/apt/lists/*
    
    # Install Python packages for reading H5AD files
    pip3 install --no-cache-dir \
        numpy \
        pandas \
        scanpy \
        anndata \
        h5py
    
    # Install R packages
    R -e "install.packages(c( \
        'reticulate', \
        'plotly', \
        'DT', \
        'shinydashboard', \
        'shinyWidgets', \
        'viridis', \
        'RColorBrewer', \
        'data.table', \
        'jsonlite' \
    ), repos='https://cloud.r-project.org/')"
    
    # Set up Python for reticulate
    R -e "library(reticulate); use_python('/usr/bin/python3', required = TRUE)"

%files
    app.R /srv/shiny-server/
    global.R /srv/shiny-server/
    server.R /srv/shiny-server/
    ui.R /srv/shiny-server/
    README.md /srv/shiny-server/

%environment
    export SCANNEX_DATA_PATH=/data
    export SHINY_PORT=3838
    export LC_ALL=C

%runscript
    echo "Starting scAnnex Dashboard..."
    echo "Data directory: ${SCANNEX_DATA_PATH}"
    echo "Access dashboard at: http://localhost:${SHINY_PORT}"
    echo ""
    
    # Start Shiny Server
    /usr/bin/shiny-server

%startscript
    /usr/bin/shiny-server

%test
    # Test that required packages are installed
    echo "Testing R packages..."
    R -e "library(shiny); library(reticulate); library(plotly); library(DT)"
    
    echo "Testing Python packages..."
    python3 -c "import scanpy; import anndata; print('Python packages OK')"
    
    echo "Container tests passed!"
