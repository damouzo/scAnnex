/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    scAnnex Nextflow config file
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Default config options for all compute environments
----------------------------------------------------------------------------------------
*/

// Global default params, used in configs
params {
    // Input options
    input                      = null
    input_type                 = 'h5ad'  // h5ad, rds, or mtx
    outdir                     = './results'
    
    // QC options (SLC: Quantile-based + Hard thresholds)
    min_genes                  = 200
    min_cells                  = 3
    max_genes                  = null
    max_counts                 = null
    max_mito_percent           = 20
    
    // Quantile-based filtering (SLC Best Practice)
    use_quantile_filtering     = true   // Enable quantile-based filtering
    feature_quantile_low       = 0.10   // 10th percentile for nFeatures
    feature_quantile_high      = 0.90   // 90th percentile for nFeatures
    count_quantile_low         = 0.10   // 10th percentile for nCounts
    count_quantile_high        = 0.90   // 90th percentile for nCounts
    
    // MAD-based thresholds (alternative method)
    use_mad_thresholds         = false  // Use MAD-based automatic thresholds
    mad_multiplier             = 5.0    // MAD multiplier for threshold calculation
    
    // Cell Attrition Log
    save_attrition_log         = true   // Save detailed cell filtering log
    
    // Doublet detection
    run_doublet_detection      = true
    doublet_removal            = true   // Remove doublets after detection
    expected_doublet_rate      = 0.05
    
    // Normalization and integration
    normalization_method       = 'log'      // log or scran
    target_sum                 = 10000
    n_top_genes                = 2000       // Number of highly variable genes
    
    // Batch correction
    run_integration            = false
    batch_key                  = null
    integration_method         = 'harmony'  // harmony, scanorama, or bbknn
    harmony_theta              = 2.0        // Harmony diversity clustering penalty
    harmony_max_iter           = 10         // Harmony maximum iterations
    
    // Dimensionality reduction
    n_pcs                      = 50
    n_neighbors                = 15
    umap_min_dist              = 0.5
    
    // Clustering (SLC: Multi-resolution clustering)
    clustering_method          = 'leiden'  // leiden or louvain
    clustering_resolutions     = '0.1,0.3,0.5,0.7,0.9'  // SLC: Multiple resolutions
    default_clustering_resolution = 0.5   // Default resolution for visualization
    
    // Auto-Annotation (SLC: CellTypist integration)
    run_auto_annotation        = true
    annotation_method          = 'celltypist'  // celltypist or marker_based
    celltypist_model           = 'Immune_All_Low.pkl'  // CellTypist model
    celltypist_majority_voting = true   // Use majority voting
    marker_list                = null   // Custom marker list (CSV format)
    
    // Interactive Dashboard
    enable_dashboard           = true   // Launch interactive dashboard after pipeline completion
    dashboard_port             = 3838   // Port for dashboard (default Shiny port)
    dashboard_host             = 'localhost'  // Host for dashboard
    
    // Boilerplate options
    publish_dir_mode           = 'copy'
    email                      = null
    email_on_fail              = null
    max_multiqc_email_size     = '25.MB'
    tracedir                   = "${params.outdir}/pipeline_info"
    help                       = false
    version                    = false
    
    // Config options
    config_profile_name        = null
    config_profile_description = null
    custom_config_version      = 'master'
    custom_config_base         = "https://raw.githubusercontent.com/nf-core/configs/${params.custom_config_version}"
    
    // Max resource options
    // Note: These defaults are conservative. Override with --max_memory, --max_cpus
    // or use profiles: -profile docker,laptop for low-memory systems
    // For laptops/local systems with limited RAM, set --max_memory '8.GB'
    max_memory                 = '128.GB'
    max_cpus                   = 16
    max_time                   = '240.h'
    
    // Schema validation default options
    validationFailUnrecognisedParams = false
    validationLenientMode            = false
    validationSchemaIgnoreParams     = 'genomes'
    validationShowHiddenParams       = false
    validate_params                  = true
}

// Load nf-validation plugin for parameter validation
plugins {
    id 'nf-validation@1.1.3'
}

// Load base.config by default for all pipelines
includeConfig 'conf/base.config'

// Load modules.config for DSL2 module specific options
includeConfig 'conf/modules.config'

// Execution Profiles
// Choose a profile with: nextflow run main.nf -profile <profile_name>
// 
// RECOMMENDED profiles (in order of preference):
// 1. Wave:           -profile wave       (builds containers from conda, most reproducible)
// 2. Conda:          -profile conda      (works everywhere, no containers needed)
// 3. Singularity:    -profile singularity (HPC standard, uses fallback containers)
// 4. Docker:         -profile docker     (local dev, uses fallback containers)
//
// Note: Container profiles use scanpy:1.7.2 as fallback (conda specs request >=1.9).
//       For exact version matching, use Wave or Conda profiles.
//
// If no profile is specified, Nextflow will use conda environments by default.
// For more details, see: docs/EXECUTION_PROFILES.md

profiles {
    debug {
        dumpHashes             = true
        process.beforeScript   = 'echo $HOSTNAME'
        cleanup                = false
    }
    
    // RECOMMENDED: Singularity (for HPC, clusters, and production)
    singularity {
        singularity.enabled    = true
        singularity.autoMounts = true
        singularity.cacheDir   = "${HOME}/.singularity/cache"
        conda.enabled          = false
        docker.enabled         = false
        podman.enabled         = false
        shifter.enabled        = false
        charliecloud.enabled   = false
        apptainer.enabled      = false
    }
    
    // Apptainer (newer name for Singularity)
    apptainer {
        apptainer.enabled      = true
        apptainer.autoMounts   = true
        apptainer.cacheDir     = "${HOME}/.apptainer/cache"
        conda.enabled          = false
        docker.enabled         = false
        singularity.enabled    = false
        podman.enabled         = false
        shifter.enabled        = false
        charliecloud.enabled   = false
    }
    
    // Docker (for local development only)
    docker {
        docker.enabled         = true
        docker.runOptions      = '-u $(id -u):$(id -g)'
        conda.enabled          = false
        singularity.enabled    = false
        podman.enabled         = false
        shifter.enabled        = false
        charliecloud.enabled   = false
        apptainer.enabled      = false
    }
    
    // SLURM executor (generic HPC cluster)
    slurm {
        includeConfig 'conf/slurm.config'
    }
    
    // Apocrita HPC (QMUL cluster with SLURM)
    apocrita {
        includeConfig 'conf/apocrita.config'
    }
    
    // Conda (slowest option, use only if containers unavailable)
    conda {
        conda.enabled          = true
        docker.enabled         = false
        singularity.enabled    = false
        podman.enabled         = false
        shifter.enabled        = false
        charliecloud.enabled   = false
        apptainer.enabled      = false
        conda.channels         = ['conda-forge', 'bioconda', 'defaults']
    }
    
    // Wave (Seqera on-demand containers from conda specs)
    // Wave builds containers automatically from conda directives
    wave {
        wave.enabled           = true
        wave.strategy          = 'conda'  // Build containers from conda specs
        wave.freeze            = false    // Don't cache container specs
        docker.enabled         = true     // Wave provides containers via Docker
        docker.runOptions      = '-u $(id -u):$(id -g)'
        singularity.enabled    = false
        conda.enabled          = false    // Wave builds from conda, don't use local conda
        conda.channels         = ['conda-forge', 'bioconda', 'defaults']
    }
    
    podman {
        podman.enabled         = true
        conda.enabled          = false
        docker.enabled         = false
        singularity.enabled    = false
        shifter.enabled        = false
        charliecloud.enabled   = false
        apptainer.enabled      = false
    }
    
    test {
        includeConfig 'conf/test.config'
    }
    laptop {
        includeConfig 'conf/low_memory.config'
    }
}

// Export these variables to prevent local Python/R libraries from conflicting with those in the container
env {
    PYTHONNOUSERSITE = 1
    R_PROFILE_USER   = "/.Rprofile"
    R_ENVIRON_USER   = "/.Renviron"
}

// Capture exit codes from upstream processes when piping
process.shell = ['/bin/bash', '-euo', 'pipefail']

// Execution reports - only generate on explicit request or full runs
// Use -with-report, -with-timeline, -with-trace, -with-dag to enable
timeline {
    enabled = false
    file    = "${params.tracedir}/execution_timeline.html"
    overwrite = true
}
report {
    enabled = false
    file    = "${params.tracedir}/execution_report.html"
    overwrite = true
}
trace {
    enabled = true
    file    = "${params.tracedir}/execution_trace.txt"
    overwrite = true
}
dag {
    enabled = false
    file    = "${params.tracedir}/pipeline_dag.html"
    overwrite = true
}

manifest {
    name            = 'scannex'
    author          = 'damouzo'
    homePage        = 'https://github.com/damouzo/scAnnex'
    description     = 'Production-ready Nextflow pipeline for automated single-cell RNA-seq analysis with integrated quality control, batch correction, and interactive visualization'
    mainScript      = 'main.nf'
    nextflowVersion = '!>=23.04.0'
    version         = '0.1.0'
    doi             = ''
}
